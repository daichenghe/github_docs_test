MA1181 通用数据协议
---------------------------------------

 +---------+---------+------------+--------------+---------+---------+
 | Start 1 | Start 2 | Frame type | Data content | Check 1 | Check 2 |
 +---------+---------+------------+--------------+---------+---------+

Description:

 - Start: 每帧报文固定使用 2 字节: 0xBD 0x64.
 - Frame type: 1 字节功能码.
 - Data content: 59 字节.
 - Check: 2 字节 crc16 校验, 低字节在前, 校验范围为Start到最后一个Data content, 校验算法如下:

.. code:: c

    uint16_t CalculateCRC16(const uint8_t *puchMsg, uint32_t len)
    {
        uint16_t wCRCin = 0xFFFFu;
        uint16_t wCPoly = 0x1021u;
        uint8_t wChar = 0u;
        uint32_t i;
        while (len--)
        {
            wChar = *(puchMsg++);
            wCRCin ^= (wChar << 8u);
            for(i = 0u; i < 8u; i++)
            if(wCRCin & 0x8000u)
            {
                wCRCin = (wCRCin <<   1u) ^ wCPoly;
            }
            else
            {
                wCRCin = wCRCin <<   1u;
            }
        }
        return (wCRCin);
    }

OTA 升级数据包
---------------------

获取诊断信息
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

域控请求
+++++++++++++++++++++

+--------+------------+--------+----------------+-----------+------------------+
| Offset | Definition | Format | Length (Byte)  | LSB/MSB   | Description      |
+========+============+========+================+===========+==================+
| 0-1    | 0x8D       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 1-1    | 0x64       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 2-1    | 0x08       | UChar  | 1              | -         | Function code    |
+--------+------------+--------+----------------+-----------+------------------+
| 3-61   | 0x00       | UChar  | 59             | -         | Default 0x00     |
+--------+------------+--------+----------------+-----------+------------------+
| 62-63  | 0xXX       | UShort | 2              | LSB       | CRC              |
+--------+------------+--------+----------------+-----------+------------------+

IMU 回复
+++++++++++++++++++++

+--------+------------+--------+----------------+-----------+------------------------------+
| Offset | Definition | Format | Length (Byte)  | LSB/MSB   | Description                  |
+========+============+========+================+===========+==============================+
| 0-1    | 0x8D       | UChar  | 1              | -         | Header (fixed)               |
+--------+------------+--------+----------------+-----------+------------------------------+
| 1-1    | 0x64       | UChar  | 1              | -         | Header (fixed)               |
+--------+------------+--------+----------------+-----------+------------------------------+
| 2-1    | 0x09       | UChar  | 1              | -         | Function code                |
+--------+------------+--------+----------------+-----------+------------------------------+
| 3-4    | 0xXX       | UChar  | 2              | -         | MCT output (fixed 0x4D 0x33) |
+--------+------------+--------+----------------+-----------+------------------------------+
| 5-1    | 0xXX       | UChar  | 1              | LSB       | Output frequency(0xA0=1000Hz)|
+--------+------------+--------+----------------+-----------+------------------------------+
| 6-25   | 0xXX       | UChar  | 20             | -         | SN code                      |
+--------+------------+--------+----------------+-----------+------------------------------+
| 26-33  | 0xXX       | UChar  | 8              | -         | HW version (4 digits)        |
+--------+------------+--------+----------------+-----------+------------------------------+
| 34-41  | 0xXX       | UChar  | 8              | -         | SW version (4 digits)        |
+--------+------------+--------+----------------+-----------+------------------------------+
| 42-61  | 0x00       | UChar  | 20             | -         | Default 0x00                 |
+--------+------------+--------+----------------+-----------+------------------------------+
| 62-63  | 0xXX       | UShort | 2              | LSB       | CRC                          |
+--------+------------+--------+----------------+-----------+------------------------------+

| 版本号示例:
| 例如, SW01 为: 00 00 00 00 53 57 30 31
| **版本号按照数字叠加 (SW01, SW02, SW03, etc.), HW同理.**


获取分区信息
~~~~~~~~~~~~~~~~~~~~

域控请求
+++++++++++++++++++++

+--------+------------+--------+----------------+-----------+------------------+
| Offset | Definition | Format | Length (Byte)  | LSB/MSB   | Description      |
+========+============+========+================+===========+==================+
| 0      | 0x8D       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 1      | 0x64       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 2      | 0x08       | UChar  | 1              | -         | Function code    |
+--------+------------+--------+----------------+-----------+------------------+
| 3-61   | 0x00       | UChar  | 59             | -         | Default 0x00     |
+--------+------------+--------+----------------+-----------+------------------+
| 62-63  | 0xXX       | UShort | 2              | LSB       | CRC              |
+--------+------------+--------+----------------+-----------+------------------+

IMU回复
++++++++++++++++++++++

+--------+------------+--------+----------------+-----------+------------------+
| Offset | Definition | Format | Length (Byte)  | LSB/MSB   | Description      |
+========+============+========+================+===========+==================+
| 0      | 0x8D       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 1      | 0x64       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 2      | 0x08       | UChar  | 1              | -         | Function code    |
+--------+------------+--------+----------------+-----------+------------------+
| 3-4    | 0xXX       | UChar  | 2              | -         | AA||BB||NA       |
+--------+------------+--------+----------------+-----------+------------------+
| 5-61   | 0x00       | UChar  | 57             | -         | Default 0x00     |
+--------+------------+--------+----------------+-----------+------------------+
| 62-63  | 0xXX       | UShort | 2              | LSB       | CRC              |
+--------+------------+--------+----------------+-----------+------------------+

| **当前有效分区为A分区, 则回复AA, 当前有效分区为B分区, 则回复BB, 若当前AB分区均未激活则回复NA.**

App跳转Bootloader
~~~~~~~~~~~~~~~~~~~~

域控请求
+++++++++++++++++++++

+--------+------------+--------+----------------+-----------+------------------+
| Offset | Definition | Format | Length (Byte)  | LSB/MSB   | Description      |
+========+============+========+================+===========+==================+
| 0      | 0x8D       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 1      | 0x64       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 2      | 0x30       | UChar  | 1              | -         | Function code    |
+--------+------------+--------+----------------+-----------+------------------+
| 3-61   | 0x00       | UChar  | 59             | -         | Default 0x00     |
+--------+------------+--------+----------------+-----------+------------------+
| 62-63  | 0xXX       | UShort | 2              | LSB       | CRC              |
+--------+------------+--------+----------------+-----------+------------------+

IMU回复
++++++++++++++++++++++

| IMU收到后会立刻跳转到Bootloader, 所以无回复, 可通过后续其他命令比如获取bootloader版本信息等判断是否跳转成功

Bootloader跳转App
~~~~~~~~~~~~~~~~~~~~

域控请求
+++++++++++++++++++++

+--------+------------+--------+----------------+-----------+------------------+
| Offset | Definition | Format | Length (Byte)  | LSB/MSB   | Description      |
+========+============+========+================+===========+==================+
| 0      | 0x8D       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 1      | 0x64       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 2      | 0x20       | UChar  | 1              | -         | Function code    |
+--------+------------+--------+----------------+-----------+------------------+
| 3-61   | 0x00       | UChar  | 59             | -         | Default 0x00     |
+--------+------------+--------+----------------+-----------+------------------+
| 62-63  | 0xXX       | UShort | 2              | LSB       | CRC              |
+--------+------------+--------+----------------+-----------+------------------+

IMU回复
++++++++++++++++++++++

| IMU收到后会立刻跳转到App, 所以无回复, 可通过后续其他命令比如获取应用报文等判断是否跳转成功


Boot版本号查询协议
~~~~~~~~~~~~~~~~~

主机请求协议
+++++++++++++++++++++

+--------+------------+--------+----------------+-----------+------------------+
| Offset | Definition | Format | Length (Byte)  | LSB/MSB   | Description      |
+========+============+========+================+===========+==================+
| 0      | 0xBD       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 1      | 0x64       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 2      | 0x06       | UChar  | 1              | -         | Function code    |
+--------+------------+--------+----------------+-----------+------------------+
| 3-61   | 0x00       | UChar  | 59             | -         | Default 0x00     |
+--------+------------+--------+----------------+-----------+------------------+
| 62-63  | 0xXX       | UShort | 2              | LSB       | CRC              |
+--------+------------+--------+----------------+-----------+------------------+

IMU 响应协议
+++++++++++++++++++++

+--------+------------+--------+----------------+-----------+------------------+
| Offset | Definition | Format | Length (Byte)  | LSB/MSB   | Description      |
+========+============+========+================+===========+==================+
| 0      | 0xBD       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 1      | 0x64       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 2      | 0x06       | UChar  | 1              | -         | Function code    |
+--------+------------+--------+----------------+-----------+------------------+
| 3-34   | 0xXX       | UChar  | 32             | -         | Boot version     |
+--------+------------+--------+----------------+-----------+------------------+
| 35-61  | 0x00       | UChar  | 27             | -         | Default 0x00     |
+--------+------------+--------+----------------+-----------+------------------+
| 62-63  | 0xXX       | UShort | 2              | LSB       | CRC              |
+--------+------------+--------+----------------+-----------+------------------+

| bootloader版本号分为产品名称及版本号, 示例: "MA1181X, IMU App v01.00.00-rc"



OTA烧写请求
~~~~~~~~~~~~~~~~~

主机请求协议
+++++++++++++++++++++

+--------+------------+--------+----------------+-----------+------------------+
| Offset | Definition | Format | Length (Byte)  | LSB/MSB   | Description      |
+========+============+========+================+===========+==================+
| 0      | 0xBD       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 1      | 0x64       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 2      | 0x21       | UChar  | 1              | -         | Function code    |
+--------+------------+--------+----------------+-----------+------------------+
| 3-5    | 0xXX       | UChar  | 3              | -         | Address Offset   |
+--------+------------+--------+----------------+-----------+------------------+
| 6-61   | 0xXX       | UChar  | 56             | -         | Firmware data    |
+--------+------------+--------+----------------+-----------+------------------+
| 62-63  | 0xXX       | UShort | 2              | LSB       | CRC              |
+--------+------------+--------+----------------+-----------+------------------+

Address Offset: **3字节地址偏移, 高字节在前**

IMU 响应协议
+++++++++++++++++++++

+--------+------------+--------+----------------+-----------+------------------+
| Offset | Definition | Format | Length (Byte)  | LSB/MSB   | Description      |
+========+============+========+================+===========+==================+
| 0      | 0xBD       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 1      | 0x64       | UChar  | 1              | -         | Header (fixed)   |
+--------+------------+--------+----------------+-----------+------------------+
| 2      | 0x06       | UChar  | 1              | -         | Function code    |
+--------+------------+--------+----------------+-----------+------------------+
| 3      | 0xXX       | UChar  | 1              | -         | Upgrade status   |
+--------+------------+--------+----------------+-----------+------------------+
| 4-61   | 0x00        | UChar | 58             | -         | Default 0x00     |
+--------+------------+--------+----------------+-----------+------------------+
| 62-63  | 0xXX       | UShort | 2              | LSB       | CRC              |
+--------+------------+--------+----------------+-----------+------------------+

Upgrade status: flash操作失败回复0, 成功回复1
